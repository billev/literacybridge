#ifdef USBRP

//from main.c

#define SYS_CREATEVAR
#define CREATE_BS_VAR
#define CREATGUIVAR
#define CREATEKEYDECODEVAR

#include "./system/include/system_head.h"
#include "./driver/include/driver_head.h"
#include "./component/include/component_head.h"
#include "./Application/TalkingBook/Include/mainloop.h"


//from USB.c
#define		CREAT_DRIVERLAYER_STRUCT
#define		CREATUSBHOSTVAR

#include	"typedef.h"
#include	"DriverLayer.h"
#include	"./Driver/Include/USBHost/USBHostMSDC.h"	
#include	"./Driver/Include/USBHost/USB_Host_RAM.h"


#define C_DISK1_FLAG	0x0001
#define C_DISK2_FLAG	0x0002
#define C_DISK3_FLAG	0x0004
#define C_DISK4_FLAG	0x0008

INT16 bUSB_Init = -1;
INT16 bUSB_LUN_Init;

unsigned int arUSBHostBuffer[256];
unsigned int arUSBHostCSWBuffer[16];

#define USBHOST_SUPPROT_2K_BLOCK

#define USBHOST_BUFFER_SIZE_2K 		//netac need this

//=========================================================================
#ifdef	USBHOST_SUPPROT_2K_BLOCK

#ifdef USBHOST_BUFFER_SIZE_8K
	#define C_BUFFERSIZE				0x1000
	#define C_BUF2SECMASK				0x0f		//one buffer can load 16 sectors
#elif defined USBHOST_BUFFER_SIZE_4K
	#define C_BUFFERSIZE				0x800
	#define C_BUF2SECMASK				0x07		//one buffer can load 8 sectors
#elif defined USBHOST_BUFFER_SIZE_2K
	#define C_BUFFERSIZE				0x400		//2k
	#define C_BUF2SECMASK				0x03		//one buffer can load 4 sectors
#endif

#define C_EMPTY						0
#define C_VALID						1
#define C_MODIFIED					2

typedef struct 
{
	unsigned int Flag;	
	unsigned int Disk;				//usb host disk num, is 0, 1, 2...
	unsigned long BlkNo;			//the block number
	unsigned int Buffer[C_BUFFERSIZE];
}USBHOSTBUFFER;

USBHOSTBUFFER gUSBHostBuffer;
unsigned long gBlk2BufMask;
unsigned int gSec2BlkSft;
unsigned int gBlk2BufCnt;

#endif		//end of SUPPROT_2K_BLOCK

extern USBHost_Initial_1();
extern USBHost_Uninitial_1();
extern USBHost_GetDrvInfo_1();
extern USBHost_ReadSector_1();
extern USBHost_WriteSector_1();


struct Drv_FileSystem FS_USB_driver = {
	"USB" ,
	DEVICE_READ_ALLOW|DEVICE_WRITE_ALLOW ,
	USBHost_Initial_1 ,
	USBHost_Uninitial_1 ,
	USBHost_GetDrvInfo_1 ,
	USBHost_ReadSector_1 ,
	USBHost_WriteSector_1 ,
};

//from timeline.c
#include "Application\Talkingbook\Include\talkingbook.h"
#include "Application\Talkingbook\Include/device.h"
#include "Application\Talkingbook\Include/containers.h"
#include "Application\Talkingbook\Include/timeline.h"

BlockTimeline blockTimeline[MAX_STATES];

// from containers.c

//#include "Include/talkingbook.h"
#include "Application\Talkingbook\Include/containers.h"

/*rhm could try this on REWIND[]
__attribute__((section(".code")))unsigned int SACM_A4800Mode[7] = { 32000, 36000, 40000, 44000, 48000, 52000, 56000 };
rhm */

const int REWIND[] = {0,500,1000,1500,2000,3000,5000,10000};


Context context;
CtnrPackage pkgSystem, pkgUser, pkgDefault;

typedef struct StackFrame StackFrame;
struct StackFrame {
	// This struct could be compressed more, but there should be very few stackFrames in memory at once.
	CtnrPackage *package;
	CtnrFile *file;
	int offset; 
};

StackFrame stack[MAX_HYPERLINK_STACK];
int stackCount = 0;

// from files.c

#include "Application\Talkingbook\Include/files.h"

long filePosition;
char logBuffer[LOG_BUFFER_SIZE];
int idxLogBuffer = 0;

BOOL firstBuffer = TRUE;
BOOL lastBuffer = FALSE;
BOOL done = FALSE;
char * cursor;

// from FS_user_nos.c

#include ".\System\include\system\GPL162002.h"
#include ".\Component\Include\FS\typedef.h"  // for BOOL
#include ".\Application\TalkingBook\Include\sys_counters.h"

#define	C_SEEK_SPEEDUP_SUPPORT

#ifdef C_SEEK_SPEEDUP_SUPPORT
int				gSeekSpeedupBufferFlag;
unsigned int	gSeekSpeedupBuffer[512];
#endif


// from macro.c

#include ".\Application\TalkingBook\Include/macro.h"

#define MAX_MACRO_ITEMS     100
#define MAX_MACRO_LOOPS     10

MacroInstr macro[MAX_MACRO_ITEMS];
MacroLoop loop[MAX_MACRO_LOOPS];
int MAX_RETRIES = 3;
int idxMacro = 0;
long secLastMacro = 0;
int idxLoop = 0;
int countLoop = 0;


// from SystemIntoUSB.c

unsigned long  usb_time_out;

#define C_USBDiskPlugIn 		0x01
#define C_USBDiskPlugOut  		0x02
#define C_USBPlugInTimeOut		0x03
#define C_USBDevicesmountOK    	0x00
#define C_USBDevicesUnmount    	0x05
#define C_USBHUnsearchDevices	0xfffe
#define C_USBHostError  		0xffff
typedef enum 
{
		USBDiskPlugIn  	= 		C_USBDiskPlugIn,
		USBDiskPlugOut 	=		C_USBDiskPlugOut,
		USBPlugInTimeOut = 		C_USBPlugInTimeOut,
		USBDevicesUnmount	= 	C_USBDevicesUnmount,
		USBDevicesmountOK		= C_USBDevicesmountOK,
		USBHUnsearchDevices = 	C_USBHUnsearchDevices,
		USBHostError	=		C_USBHostError
}USBHostType ;

#include "Reprog/USBD_Define.h"
#include "Reprog/USBD.h"

str_USB_Lun_Info USB_Lun_Define[] =
{
//	{0x00, LunType_NandDrive	, USB_Nand_Part0_Offset,	USB_Nand_Part0_Size, 	LunStatus_Normal},
//	{0x01, LunType_NandDrive	, USB_Nand_Part1_Offset,	USB_Nand_Part1_Size, 	LunStatus_Normal},	
	{0x00, LunType_SDCardReader	, 0L,	0L, 	LunStatus_Normal, 0L},
	//RHM
	{0x01, LunType_RAM	, 0L,	(long)(30 * 1024), 	LunStatus_Normal, 0L},
	{0x02, LunType_NOR  , 0x30000L, (long)(128 * 1024), LunStatus_Normal, 0L},
	//RHM
}; 
str_USB_Lun_Info 	*FP_USB_Lun_Define[N_USB_LUN];

#include "./Reprog/USB_Flash_reprog.h"

USBHostType  USBHost_Flag;

int fl_size;
unsigned int REPROG_IN_Progress = 0;
unsigned int RHM_USBreprogBuf_Full = 0;
unsigned int *RHM_DEBUG_LAST_LBA = 0;
unsigned int *RHM_DEBUG_LAST_WRITE = 0;
flash *RHM_FlashPtr = 0;
unsigned int *RHM_FlashBuf = 0;
long USB_INSERT_PTR;
long USB_ISR_PTR;
void (*ReprogJump)() = 0;


//from audio.c

char lastFilenameRecorded[40];
int iFileHandle;

// from device.c

int volume, speed;
unsigned long voltage; // voltage sample 
int oldVolume;
long timeLastSample = -1;
long timeInitialized = -1;
BOOL wasSampleStarted = FALSE;

//from sys_counters.c

SystemCounts systemCounts;

// frome (replacing) DrvStruct.c

#define		CREAT_DRIVERLAYER_STRUCT
#include	"DriverLayer.h"
//NAND FLASH partition define
const  UINT32 Nand_Part0_Offset = NAND_PART0_OFFSET;
const  UINT32 Nand_Part0_Size = NAND_PART0_SIZE;
const  UINT16 Nand_Part0_Mode = NAND_PART0_MODE;

const  UINT32 Nand_Part1_Offset = NAND_PART1_OFFSET;
const  UINT32 Nand_Part1_Size = NAND_PART1_SIZE;
const  UINT16 Nand_Part1_Mode = NAND_PART1_MODE;

const  UINT32 Nand_Part2_Offset = NAND_PART2_OFFSET;
const  UINT32 Nand_Part2_Size = NAND_PART2_SIZE;
const  UINT16 Nand_Part2_Mode = NAND_PART2_MODE;

const UINT32 Nand_Reserve_Offset = NAND_RESERVE_OFFSET;

int	bNandInit;
extern int bUSB_Init;

//定义不使用IRAM。在NAND BOOT的情况下不能使用IRAM（带初始值的全局变量）

struct Drv_FileSystem *FileSysDrv[NBLKDEV];

// from FS_DS.c

int SACMFileHandle = -1;
int MP3FileHandle = -1;			//added by chengye 2007/4/23
unsigned int DefaultBitRate = 32000;

#ifdef S320TTS_Used
int DataBase_fp = -1;			//added by chengye 2007/5/14
#endif

unsigned long MP3FATReadBuffer;		//从文件系统中读取数据暂时到Buffer中

// from mainLoop.c

unsigned int enteringVolume;
BOOL warnedUser = FALSE;
long lastActivity = 0;

// from startup.c

#define SYSTEM_HEAP_SIZE 512	//config file values

char systemHeap [SYSTEM_HEAP_SIZE];
char *cursorSystemHeap = systemHeap;


int KEY_PLAY, KEY_LEFT, KEY_RIGHT, KEY_UP, KEY_DOWN, KEY_SELECT, KEY_STAR, KEY_HOME, KEY_PLUS, KEY_MINUS;	
int LED_GREEN, LED_RED, LED_ALL;
int MAX_SPEED, NORMAL_SPEED, SPEED_INCREMENT;
int NORMAL_VOLUME, MAX_VOLUME, VOLUME_INCREMENT;
char *BOOT_PACKAGE, *SYSTEM_PATH, *USER_PATH, *LIST_PATH;
int MAX_PWR_CYCLES_IN_LOG;
char *SYSTEM_VARIABLE_FILE, *LOG_FILE;
char *LIST_MASTER;
char *PKG_NUM_PREFIX, *LIST_NUM_PREFIX, *CUSTOM_PKG_PREFIX;
char *AUDIO_FILE_EXT;
char *CONTROL_EXT;
int DEFAULT_TIME_PRECISION;
int DEFAULT_REWIND;
int INSERT_SOUND_REWIND_MS;
int HYPERLINK_SOUND_FILE_IDX, DELETED_FILE_IDX, BEEP_SOUND_FILE_IDX, BIP_SOUND_FILE_IDX, SPEAK_SOUND_FILE_IDX, 
    INACTIVITY_SOUND_FILE_IDX, ERROR_SOUND_FILE_IDX, EMPTY_LIST_FILE_IDX;
int BLOCK_START_LEADER, BLOCK_END_LEADER;
long BIT_RATE;
int GREEN_LED_WHEN_PLAYING;
int INACTIVITY_SECONDS;
int MIC_GAIN_NORMAL, MIC_GAIN_HEADPHONE;
char *CONTROL_TEMPLATE;
char *MACRO_FILE;
int VOLTAGE_SAMPLE_FREQ_SEC;
int LOG_WARNINGS, LOG_KEYS;


#endif //USBRP
